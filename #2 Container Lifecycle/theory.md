# Жизненный цикл контейнера: порты, логи, exec

## Для кого этот материал
Эта тема помогает уверенно управлять жизненным циклом контейнеров: запускать готовые образы, проверять их работу, диагностировать проблемы через логи и интерактивные сессии, обмениваться файлами и корректно завершать работу. После изучения ты сможешь повторять полный цикл «запуск → наблюдение → отладка → остановка → удаление» на любом образе.

---

## 1. Старт контейнера и публикация портов
1. Скачай образ и запусти контейнер в фоне:
   ```bash
   docker run --name web -d -p 8080:80 nginx
   ```
   * `--name web` — человекопонятное имя, чтобы не вспоминать случайный ID.
   * `-d` — работа в фоне (detached mode), терминал не блокируется.
   * `-p 8080:80` — пробрасываем порт 80 внутри контейнера на порт 8080 хоста. Формат `HOST:CONTAINER`.
2. Открой браузер и перейди на `http://localhost:8080`, чтобы увидеть стартовую страницу Nginx.
3. Если порт занят, измени левую часть на свободный порт (например, `-p 8081:80`).

---

## 2. Проверка состояния контейнеров
* `docker ps` — показывает работающие контейнеры.
* `docker ps -a` — выводит и остановленные контейнеры, полезно для истории запусков.
* Колонка `STATUS` помогает понять, когда контейнер стартовал и в каком он состоянии.

---

## 3. Просмотр логов (`docker logs`)
1. Для непрерывного слежения за логами используй:
   ```bash
   docker logs -f web
   ```
   * `-f` (follow) выводит новые записи в режиме реального времени.
2. Чтобы увидеть только последние строки:
   ```bash
   docker logs --tail 50 web
   ```
3. Добавь `--timestamps`, если нужны временные метки для анализа.

---

## 4. Интерактивный доступ (`docker exec`)
1. Подключись к контейнеру с shell:
   ```bash
   docker exec -it web sh
   ```
   * `-i` — интерактивный режим, `-t` — псевдо-TTY, `sh` — оболочка, доступная в образе Nginx (на Alpine-основанных образах).
2. Внутри контейнера можно:
   * Просматривать конфигурацию (`cat /etc/nginx/nginx.conf`).
   * Проверять структуру каталогов (`ls /usr/share/nginx/html`).
3. Заверши работу командой `exit`, чтобы вернуться в терминал хоста.
4. Для первых экспериментов удобно потренироваться на «учебном» Alpine-контейнере с интерактивным shell.

---

## 5. Копирование файлов (`docker cp`)
* Из контейнера на хост:
  ```bash
  docker cp web:/etc/nginx/nginx.conf ./nginx.conf
  ```
* С хоста в контейнер:
  ```bash
  docker cp ./custom.conf web:/etc/nginx/conf.d/default.conf
  ```
* После изменения конфигурации перезагрузи процесс внутри контейнера (`nginx -s reload` через `docker exec`) или перезапусти контейнер (`docker restart web`).

---

## 6. Перезапуск и остановка
* Остановить аккуратно:
  ```bash
  docker stop web
  ```
  Контейнер получает SIGTERM, и процессу даётся время завершиться.
* Принудительно остановить:
  ```bash
  docker kill web
  ```
  (SIGKILL, используйте осторожно).
* Запустить снова без пересоздания:
  ```bash
  docker start web
  ```
* Для консольных приложений можно сразу «подключить» STDIN/STDOUT при старте:
  ```bash
  docker start -ai alpine-lab
  ```

---

## 7. Удаление и очистка
1. Когда контейнер больше не нужен:
   ```bash
   docker rm web
   ```
   Команда работает только для остановленных контейнеров. Если контейнер всё ещё запущен, добавь `-f` или останови его заранее.
2. Для быстрой чистки множества остановленных контейнеров:
   ```bash
   docker container prune
   ```
   Подтверждение «y» удалит все остановленные контейнеры.

---

## 8. Полезные флаги `docker run`
* `--rm` — контейнер удаляется сразу после завершения процесса. Удобно для одноразовых запусков.
* `--restart` — политика перезапуска:
  * `--restart no` (по умолчанию) — не перезапускать.
  * `--restart on-failure[:N]` — перезапускать при ненулевом коде завершения (опционально до `N` раз).
  * `--restart unless-stopped` — поддерживать контейнер в рабочем состоянии до тех пор, пока его явно не остановят.
* `--env KEY=value` или `--env-file` — передача переменных окружения внутрь контейнера (например, параметры подключения к БД).

---

## 9. Отладочный чек-лист
1. Контейнер не стартует? Посмотри логи (`docker logs web`) — там часто указывают причину (ошибки конфигурации, нехватка порта).
2. Приложение не отвечает по HTTP? Проверь:
   * Правильно ли опубликован порт (`docker ps` → колонка `PORTS`).
   * Внутри контейнера сервис слушает ожидаемый порт (`docker exec web ss -tlnp`).
   * Настройки файрволла/SELinux на хосте.
3. Настроил конфиг? Убедись, что изменения попали в контейнер (`docker exec` + `cat`) и перезапусти службу.

---

## 10. Закрепление
* Повтори команды из раздела практики: `docker run`, `docker logs`, `docker exec`, `docker cp`, `docker stop`, `docker start`, `docker rm`.
* Поэкспериментируй с `--env`, `--rm` и `--restart`, чтобы увидеть влияние на жизненный цикл.
* Практикуйся переходить по циклу «запуск → наблюдение → отладка → остановка → удаление», чтобы развить уверенность.

